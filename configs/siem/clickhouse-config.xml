<?xml version="1.0"?>
<!--
    XDR Platform ClickHouse Configuration
    보안 로그 분석을 위한 최적화 설정
-->
<clickhouse>
    <!-- 로깅 설정 -->
    <logger>
        <level>information</level>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
    </logger>

    <!-- HTTP 인터페이스 -->
    <http_port>8123</http_port>
    <https_port>8443</https_port>

    <!-- Native 프로토콜 -->
    <tcp_port>9000</tcp_port>
    <tcp_port_secure>9440</tcp_port_secure>

    <!-- 인터서버 통신 (클러스터) -->
    <interserver_http_port>9009</interserver_http_port>

    <!-- 리스닝 주소 -->
    <listen_host>0.0.0.0</listen_host>

    <!-- 최대 연결 수 -->
    <max_connections>4096</max_connections>

    <!-- 동시 쿼리 제한 -->
    <max_concurrent_queries>100</max_concurrent_queries>

    <!-- 메모리 설정 -->
    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>
    <max_memory_usage>10000000000</max_memory_usage> <!-- 10GB per query -->

    <!-- 데이터 경로 -->
    <path>/var/lib/clickhouse/</path>
    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>
    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>

    <!-- 스토리지 정책 (Hot-Warm-Cold) -->
    <storage_configuration>
        <disks>
            <hot>
                <path>/var/lib/clickhouse/hot/</path>
                <keep_free_space_bytes>10737418240</keep_free_space_bytes> <!-- 10GB -->
            </hot>
            <warm>
                <path>/var/lib/clickhouse/warm/</path>
                <keep_free_space_bytes>10737418240</keep_free_space_bytes>
            </warm>
            <cold>
                <path>/var/lib/clickhouse/cold/</path>
                <keep_free_space_bytes>10737418240</keep_free_space_bytes>
            </cold>
            <s3_archive>
                <type>s3</type>
                <endpoint>http://minio:9000/xdr-archive/</endpoint>
                <access_key_id>minioadmin</access_key_id>
                <secret_access_key>minioadmin</secret_access_key>
            </s3_archive>
        </disks>
        <policies>
            <xdr_tiered>
                <volumes>
                    <hot>
                        <disk>hot</disk>
                        <max_data_part_size_bytes>1073741824</max_data_part_size_bytes> <!-- 1GB -->
                    </hot>
                    <warm>
                        <disk>warm</disk>
                        <max_data_part_size_bytes>10737418240</max_data_part_size_bytes> <!-- 10GB -->
                    </warm>
                    <cold>
                        <disk>cold</disk>
                    </cold>
                </volumes>
                <move_factor>0.2</move_factor>
            </xdr_tiered>
        </policies>
    </storage_configuration>

    <!-- MergeTree 설정 -->
    <merge_tree>
        <min_bytes_for_wide_part>10485760</min_bytes_for_wide_part> <!-- 10MB -->
        <max_bytes_to_merge_at_max_space_in_pool>161061273600</max_bytes_to_merge_at_max_space_in_pool>
        <max_bytes_to_merge_at_min_space_in_pool>1048576</max_bytes_to_merge_at_min_space_in_pool>
        <max_replicated_merges_in_queue>16</max_replicated_merges_in_queue>
        <number_of_free_entries_in_pool_to_lower_max_size_of_merge>8</number_of_free_entries_in_pool_to_lower_max_size_of_merge>
        <parts_to_delay_insert>150</parts_to_delay_insert>
        <parts_to_throw_insert>300</parts_to_throw_insert>
        <max_delay_to_insert>1</max_delay_to_insert>
    </merge_tree>

    <!-- 압축 설정 -->
    <compression>
        <case>
            <min_part_size>10000000000</min_part_size>
            <min_part_size_ratio>0.01</min_part_size_ratio>
            <method>zstd</method>
            <level>3</level>
        </case>
    </compression>

    <!-- 사용자 정의 설정 -->
    <profiles>
        <default>
            <max_memory_usage>10000000000</max_memory_usage>
            <use_uncompressed_cache>0</use_uncompressed_cache>
            <load_balancing>random</load_balancing>
        </default>

        <xdr_analyst>
            <max_memory_usage>20000000000</max_memory_usage>
            <max_execution_time>300</max_execution_time>
            <max_rows_to_read>1000000000</max_rows_to_read>
            <readonly>1</readonly>
        </xdr_analyst>

        <xdr_admin>
            <max_memory_usage>30000000000</max_memory_usage>
            <max_execution_time>600</max_execution_time>
            <readonly>0</readonly>
        </xdr_admin>

        <xdr_ingestion>
            <max_memory_usage>5000000000</max_memory_usage>
            <max_insert_threads>4</max_insert_threads>
            <max_threads>8</max_threads>
        </xdr_ingestion>
    </profiles>

    <!-- 사용자 설정 -->
    <users>
        <default>
            <password></password>
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <quota>default</quota>
        </default>

        <xdr_reader>
            <password_sha256_hex><!-- SHA256 해시 --></password_sha256_hex>
            <networks>
                <ip>10.0.0.0/8</ip>
                <ip>172.16.0.0/12</ip>
                <ip>192.168.0.0/16</ip>
            </networks>
            <profile>xdr_analyst</profile>
            <quota>default</quota>
            <databases>
                <xdr>
                    <table>*</table>
                </xdr>
            </databases>
        </xdr_reader>

        <xdr_writer>
            <password_sha256_hex><!-- SHA256 해시 --></password_sha256_hex>
            <networks>
                <ip>10.0.0.0/8</ip>
            </networks>
            <profile>xdr_ingestion</profile>
            <quota>default</quota>
        </xdr_writer>

        <xdr_admin>
            <password_sha256_hex><!-- SHA256 해시 --></password_sha256_hex>
            <networks>
                <ip>10.0.0.100/32</ip> <!-- SOC 관리 서버만 -->
            </networks>
            <profile>xdr_admin</profile>
            <quota>default</quota>
            <access_management>1</access_management>
        </xdr_admin>
    </users>

    <!-- 쿼터 설정 -->
    <quotas>
        <default>
            <interval>
                <duration>3600</duration>
                <queries>0</queries>
                <errors>0</errors>
                <result_rows>0</result_rows>
                <read_rows>0</read_rows>
                <execution_time>0</execution_time>
            </interval>
        </default>
    </quotas>

    <!-- 분산 DDL -->
    <distributed_ddl>
        <path>/clickhouse/task_queue/ddl</path>
    </distributed_ddl>

    <!-- ZooKeeper (클러스터 모드) -->
    <!--
    <zookeeper>
        <node>
            <host>zk1.example.com</host>
            <port>2181</port>
        </node>
        <node>
            <host>zk2.example.com</host>
            <port>2181</port>
        </node>
        <node>
            <host>zk3.example.com</host>
            <port>2181</port>
        </node>
    </zookeeper>
    -->

    <!-- 클러스터 설정 -->
    <!--
    <remote_servers>
        <xdr_cluster>
            <shard>
                <replica>
                    <host>ch-node1.example.com</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>ch-node2.example.com</host>
                    <port>9000</port>
                </replica>
            </shard>
            <shard>
                <replica>
                    <host>ch-node3.example.com</host>
                    <port>9000</port>
                </replica>
                <replica>
                    <host>ch-node4.example.com</host>
                    <port>9000</port>
                </replica>
            </shard>
        </xdr_cluster>
    </remote_servers>
    -->

    <!-- 쿼리 로그 -->
    <query_log>
        <database>system</database>
        <table>query_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </query_log>

    <!-- 쿼리 스레드 로그 -->
    <query_thread_log>
        <database>system</database>
        <table>query_thread_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </query_thread_log>

    <!-- Prometheus 메트릭 -->
    <prometheus>
        <endpoint>/metrics</endpoint>
        <port>9363</port>
        <metrics>true</metrics>
        <events>true</events>
        <asynchronous_metrics>true</asynchronous_metrics>
    </prometheus>
</clickhouse>
