# Splunk Correlation Searches for XDR
# 위치: $SPLUNK_HOME/etc/apps/xdr_app/local/savedsearches.conf

[XDR - Brute Force Login Attempts]
description = 다수의 로그인 실패 후 성공 탐지
search = index=auth sourcetype=WinEventLog:Security (EventCode=4625 OR EventCode=4624) \
| stats count(eval(EventCode=4625)) as failures count(eval(EventCode=4624)) as success by src_ip, user \
| where failures > 5 AND success > 0
alert.severity = 4
alert.suppress = 1
alert.suppress.period = 1h
action.notable = 1
action.notable.param.rule_title = Brute Force Login Detected
action.notable.param.rule_description = Multiple login failures followed by success from $src_ip$ for user $user$
action.notable.param.security_domain = access
action.notable.param.severity = high
cron_schedule = */5 * * * *

[XDR - Suspicious Process Chain]
description = 의심스러운 프로세스 실행 체인 탐지
search = index=edr sourcetype=edr:process \
| transaction host maxspan=5m startswith=(parent_process_name="outlook.exe" OR parent_process_name="chrome.exe") \
| search process_name IN ("powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe") \
| where eventcount > 1
alert.severity = 4
action.notable = 1
action.notable.param.rule_title = Suspicious Process Chain Detected
action.notable.param.security_domain = endpoint
action.notable.param.severity = high
cron_schedule = */5 * * * *

[XDR - Cross-Layer C2 Detection]
description = EDR 프로세스 이벤트와 NDR 네트워크 이벤트 상관분석
search = index=edr sourcetype=edr:process process_name="powershell.exe" \
| join type=inner host \
    [search index=ndr sourcetype=ndr:flow dest_port IN (443, 8443, 4444) bytes_out > 10000] \
| stats count by host, process_name, dest_ip, dest_port
alert.severity = 5
action.notable = 1
action.notable.param.rule_title = Potential C2 Communication Detected
action.notable.param.security_domain = network
action.notable.param.severity = critical
cron_schedule = */5 * * * *

[XDR - Data Exfiltration Indicator]
description = 대용량 데이터 외부 전송 탐지
search = index=ndr sourcetype=ndr:flow direction=outbound \
| stats sum(bytes_out) as total_bytes by src_ip, dest_ip \
| where total_bytes > 104857600 \
| lookup threat_intel_ip dest_ip OUTPUT threat_score \
| where threat_score > 50 OR isnull(threat_score)
alert.severity = 4
action.notable = 1
action.notable.param.rule_title = Potential Data Exfiltration
action.notable.param.security_domain = network
action.notable.param.severity = high
cron_schedule = */15 * * * *

[XDR - Lateral Movement Detection]
description = 내부 네트워크 이동 탐지
search = index=auth sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3 \
| stats dc(dest_host) as unique_hosts values(dest_host) as hosts by src_ip, user \
| where unique_hosts > 3
alert.severity = 3
action.notable = 1
action.notable.param.rule_title = Potential Lateral Movement
action.notable.param.security_domain = access
action.notable.param.severity = medium
cron_schedule = */10 * * * *
