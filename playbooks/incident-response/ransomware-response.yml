# SOAR Playbook: ëœì„¬ì›¨ì–´ ëŒ€ì‘
# í”Œë«í¼: Splunk SOAR / Shuffle / n8n í˜¸í™˜ ì˜ì‚¬ì½”ë“œ

name: Ransomware Incident Response
description: ëœì„¬ì›¨ì–´ ê°ì—¼ íƒì§€ ì‹œ ê¸´ê¸‰ ëŒ€ì‘ í”Œë ˆì´ë¶
version: 1.0
author: Security Team
severity: critical

triggers:
  - source: EDR
    condition: detection.category == "ransomware"
  - source: SIEM
    condition: |
      alert.type == "file_encryption" OR
      alert.type == "shadow_copy_deletion" OR
      alert.type == "ransom_note_detected"

inputs:
  - host_name: "ê°ì—¼ëœ í˜¸ìŠ¤íŠ¸ëª…"
  - host_ip: "í˜¸ìŠ¤íŠ¸ IP ì£¼ì†Œ"
  - affected_files: "ì•”í˜¸í™”ëœ íŒŒì¼ ëª©ë¡"
  - user: "ê´€ë ¨ ì‚¬ìš©ì"
  - alert_id: "ì•Œë¦¼ ID"
  - detection_time: "íƒì§€ ì‹œê°„"

workflow:
  # Phase 1: ì¦‰ì‹œ ê²©ë¦¬ (ìë™)
  - step: 1
    name: "ê¸´ê¸‰ ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬"
    actions:
      - action: isolate_host
        target: EDR
        params:
          hostname: "{{ host_name }}"
          isolation_type: "full"
        output: isolation_result
        timeout: 30s

      - action: block_ip
        target: Firewall
        params:
          ip: "{{ host_ip }}"
          rule_name: "RANSOMWARE_QUARANTINE_{{ host_name }}"
          duration: "indefinite"
        output: firewall_result

      - action: disable_user
        target: AD
        params:
          username: "{{ user }}"
          reason: "ëœì„¬ì›¨ì–´ ê°ì—¼ ì˜ì‹¬"
        output: user_disable_result

  # Phase 2: í™•ì‚° ë°©ì§€
  - step: 2
    name: "ë„¤íŠ¸ì›Œí¬ ì„¸ê·¸ë¨¼íŠ¸ ê²©ë¦¬"
    actions:
      - action: get_network_segment
        target: CMDB
        params:
          ip: "{{ host_ip }}"
        output: network_segment

      - action: block_segment_traffic
        target: Firewall
        params:
          segment: "{{ network_segment.vlan }}"
          allow_list:
            - "SOC_NETWORK"
            - "BACKUP_NETWORK"
        output: segment_isolation
        condition: network_segment.criticality == "high"

      - action: get_connected_hosts
        target: NDR
        params:
          host_ip: "{{ host_ip }}"
          time_range: "1h"
        output: connected_hosts

  # Phase 3: ì˜í–¥ ë²”ìœ„ íŒŒì•…
  - step: 3
    name: "ì˜í–¥ ë²”ìœ„ ë¶„ì„"
    actions:
      - action: scan_for_iocs
        target: EDR
        params:
          hosts: "{{ connected_hosts }}"
          iocs:
            - type: "file_extension"
              value: ".encrypted,.locked,.crypto"
            - type: "file_name"
              value: "README_DECRYPT.*,HOW_TO_RECOVER.*"
            - type: "process"
              value: "vssadmin.exe,wmic.exe,bcdedit.exe"
        output: affected_scope

      - action: check_shared_drives
        target: FileServer
        params:
          user: "{{ user }}"
        output: shared_drive_status

  # Phase 4: ì¦ê±° ìˆ˜ì§‘
  - step: 4
    name: "í¬ë Œì‹ ë°ì´í„° ìˆ˜ì§‘"
    actions:
      - action: capture_memory
        target: EDR
        params:
          hostname: "{{ host_name }}"
          priority: "high"
        output: memory_dump

      - action: collect_artifacts
        target: EDR
        params:
          hostname: "{{ host_name }}"
          artifacts:
            - running_processes
            - network_connections
            - registry_run_keys
            - scheduled_tasks
            - recent_files
            - prefetch
            - amcache
        output: forensic_artifacts

      - action: collect_ransom_note
        target: EDR
        params:
          hostname: "{{ host_name }}"
          patterns:
            - "*README*.txt"
            - "*DECRYPT*.txt"
            - "*RECOVER*.html"
        output: ransom_note

  # Phase 5: ëœì„¬ì›¨ì–´ ì‹ë³„
  - step: 5
    name: "ëœì„¬ì›¨ì–´ ë³€ì¢… ì‹ë³„"
    actions:
      - action: analyze_ransom_note
        target: ThreatIntel
        params:
          content: "{{ ransom_note.content }}"
        output: ransomware_family

      - action: lookup_decryptor
        target: NoMoreRansom
        params:
          family: "{{ ransomware_family.name }}"
        output: decryptor_available

      - action: get_iocs
        target: MISP
        params:
          family: "{{ ransomware_family.name }}"
        output: ransomware_iocs

  # Phase 6: ì¶”ê°€ í˜¸ìŠ¤íŠ¸ ìŠ¤ìº”
  - step: 6
    name: "ì „ì‚¬ IOC ìŠ¤ìº”"
    actions:
      - action: push_iocs
        target: EDR
        params:
          iocs: "{{ ransomware_iocs }}"
          action: "detect_and_alert"
        output: ioc_push_result

      - action: hunt_query
        target: SIEM
        params:
          query: |
            index=edr
            (process_name IN ("vssadmin.exe", "wmic.exe", "bcdedit.exe")
             OR file_extension IN (".encrypted", ".locked"))
            | stats count by host, user
          time_range: "-24h"
        output: hunt_results

  # Phase 7: ì•Œë¦¼ ë° ì—ìŠ¤ì»¬ë ˆì´ì…˜
  - step: 7
    name: "ê¸´ê¸‰ ì•Œë¦¼"
    actions:
      - action: send_notification
        target: PagerDuty
        params:
          severity: "critical"
          title: "ğŸš¨ ëœì„¬ì›¨ì–´ ê°ì—¼ - ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”"
          description: |
            í˜¸ìŠ¤íŠ¸: {{ host_name }}
            ì‚¬ìš©ì: {{ user }}
            ëœì„¬ì›¨ì–´: {{ ransomware_family.name }}
            íƒì§€ ì‹œê°„: {{ detection_time }}
            ê²©ë¦¬ ìƒíƒœ: {{ isolation_result.status }}
          escalation_policy: "security_critical"

      - action: send_notification
        target: Email
        params:
          to:
            - "ciso@company.com"
            - "it-director@company.com"
            - "soc@company.com"
          subject: "[ê¸´ê¸‰-ëœì„¬ì›¨ì–´] ë³´ì•ˆ ì¸ì‹œë˜íŠ¸ ë°œìƒ - {{ host_name }}"
          template: "ransomware_executive_notification"
          attachments:
            - "{{ forensic_artifacts.summary }}"

      - action: send_notification
        target: Slack
        params:
          channel: "#security-incidents"
          message: |
            :rotating_light: *ëœì„¬ì›¨ì–´ ì¸ì‹œë˜íŠ¸*

            *í˜¸ìŠ¤íŠ¸:* {{ host_name }}
            *ì‚¬ìš©ì:* {{ user }}
            *ëœì„¬ì›¨ì–´ íŒ¨ë°€ë¦¬:* {{ ransomware_family.name }}
            *ì˜í–¥ í˜¸ìŠ¤íŠ¸ ìˆ˜:* {{ affected_scope.count }}
            *ë³µí˜¸í™” ë„êµ¬:* {{ decryptor_available.status }}

            *ëŒ€ì‘ ìƒíƒœ:*
            - í˜¸ìŠ¤íŠ¸ ê²©ë¦¬: âœ…
            - ì‚¬ìš©ì ë¹„í™œì„±í™”: âœ…
            - í¬ë Œì‹ ìˆ˜ì§‘: âœ…

            ì¼€ì´ìŠ¤: #{{ alert_id }}

  # Phase 8: ì¼€ì´ìŠ¤ ê´€ë¦¬
  - step: 8
    name: "ì¸ì‹œë˜íŠ¸ ì¼€ì´ìŠ¤ ìƒì„±"
    actions:
      - action: create_case
        target: TheHive
        params:
          title: "ëœì„¬ì›¨ì–´ ê°ì—¼ - {{ ransomware_family.name }} - {{ host_name }}"
          severity: 4
          tlp: 3
          pap: 2
          tags:
            - "ransomware"
            - "{{ ransomware_family.name }}"
            - "critical"
          tasks:
            - title: "ì˜í–¥ ë²”ìœ„ í™•ì¸"
              status: "completed"
            - title: "í¬ë Œì‹ ë¶„ì„"
              status: "in_progress"
            - title: "ë³µêµ¬ ê³„íš ìˆ˜ë¦½"
              status: "waiting"
            - title: "ê·¼ë³¸ ì›ì¸ ë¶„ì„"
              status: "waiting"
            - title: "ê²½ì˜ì§„ ë³´ê³ "
              status: "waiting"
          observables:
            - type: "hostname"
              value: "{{ host_name }}"
            - type: "ip"
              value: "{{ host_ip }}"
            - type: "user"
              value: "{{ user }}"
        output: case_id

outputs:
  - isolation_status: "{{ isolation_result.status }}"
  - case_id: "{{ case_id }}"
  - ransomware_family: "{{ ransomware_family.name }}"
  - affected_hosts: "{{ affected_scope.hosts }}"
  - decryptor_available: "{{ decryptor_available.status }}"

recovery:
  # ë°±ì—…ì—ì„œ ë³µêµ¬
  - step: 1
    name: "ë°±ì—… ìƒíƒœ í™•ì¸"
    condition: manual_trigger
    actions:
      - action: check_backup_status
        target: BackupSystem
        params:
          hostname: "{{ host_name }}"
          check_integrity: true
        output: backup_status

  # ì‹œìŠ¤í…œ ë³µêµ¬
  - step: 2
    name: "ì‹œìŠ¤í…œ ì¬êµ¬ì„±"
    condition: backup_status.valid == true
    actions:
      - action: wipe_and_reimage
        target: SCCM
        params:
          hostname: "{{ host_name }}"
          image: "standard_windows_image"

      - action: restore_data
        target: BackupSystem
        params:
          hostname: "{{ host_name }}"
          restore_point: "{{ backup_status.last_clean_backup }}"
