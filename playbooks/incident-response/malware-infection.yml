# SOAR Playbook: 악성코드 감염 대응
# 플랫폼: Splunk SOAR / Shuffle / n8n 호환 의사코드

name: Malware Infection Response
description: 악성코드 감염 탐지 시 자동 대응 플레이북
version: 1.0
author: Security Team

triggers:
  - source: SIEM
    condition: alert.category == "malware" AND alert.severity >= "high"
  - source: EDR
    condition: detection.type == "malware"

inputs:
  - host_name: "감염된 호스트명"
  - host_ip: "호스트 IP 주소"
  - file_hash: "악성 파일 해시"
  - user: "관련 사용자"
  - alert_id: "알림 ID"

workflow:
  # Phase 1: 초기 분석
  - step: 1
    name: "호스트 정보 수집"
    actions:
      - action: get_host_info
        target: CMDB
        params:
          hostname: "{{ host_name }}"
        output: host_details

      - action: get_user_info
        target: AD
        params:
          username: "{{ user }}"
        output: user_details

  - step: 2
    name: "위협 인텔리전스 조회"
    actions:
      - action: lookup_hash
        target: VirusTotal
        params:
          hash: "{{ file_hash }}"
        output: vt_result

      - action: lookup_hash
        target: MISP
        params:
          hash: "{{ file_hash }}"
        output: misp_result

  # Phase 2: 격리 결정
  - step: 3
    name: "자동 격리 여부 결정"
    condition: |
      vt_result.positives >= 10 OR
      misp_result.threat_level == "high" OR
      host_details.criticality == "critical"
    on_true: step_4_isolate
    on_false: step_5_manual

  # Phase 3a: 자동 격리
  - step: 4
    name: "호스트 네트워크 격리"
    id: step_4_isolate
    actions:
      - action: isolate_host
        target: EDR
        params:
          hostname: "{{ host_name }}"
        output: isolation_result

      - action: block_ip
        target: Firewall
        params:
          ip: "{{ host_ip }}"
          duration: "24h"
        output: firewall_result

      - action: disable_user
        target: AD
        params:
          username: "{{ user }}"
        output: user_disable_result
        condition: user_details.type != "service_account"

  # Phase 3b: 수동 검토
  - step: 5
    name: "분석가 검토 요청"
    id: step_5_manual
    actions:
      - action: create_ticket
        target: ITSM
        params:
          title: "악성코드 의심 - 검토 필요: {{ host_name }}"
          priority: "high"
          assignee: "SOC Team"
          description: |
            호스트: {{ host_name }}
            사용자: {{ user }}
            파일 해시: {{ file_hash }}
            VT 탐지: {{ vt_result.positives }}/{{ vt_result.total }}
        output: ticket_id

      - action: await_approval
        timeout: 30m
        on_timeout: step_4_isolate

  # Phase 4: 포렌식 데이터 수집
  - step: 6
    name: "포렌식 데이터 수집"
    actions:
      - action: collect_artifacts
        target: EDR
        params:
          hostname: "{{ host_name }}"
          artifacts:
            - running_processes
            - network_connections
            - scheduled_tasks
            - startup_items
            - recent_files
        output: forensic_data

      - action: capture_memory
        target: EDR
        params:
          hostname: "{{ host_name }}"
        output: memory_dump
        condition: host_details.criticality == "critical"

  # Phase 5: 알림 및 보고
  - step: 7
    name: "관계자 알림"
    actions:
      - action: send_notification
        target: Email
        params:
          to:
            - "{{ user_details.manager }}"
            - "soc@company.com"
          subject: "[보안] 악성코드 감염 대응 - {{ host_name }}"
          template: "malware_notification"

      - action: send_notification
        target: Slack
        params:
          channel: "#security-alerts"
          message: |
            :warning: 악성코드 감염 대응 완료
            - 호스트: {{ host_name }}
            - 격리 상태: {{ isolation_result.status }}
            - 케이스: {{ ticket_id }}

  # Phase 6: 케이스 업데이트
  - step: 8
    name: "케이스 문서화"
    actions:
      - action: update_case
        target: TheHive
        params:
          case_id: "{{ alert_id }}"
          status: "in_progress"
          summary: |
            ## 자동 대응 완료

            ### 수행된 작업
            - 호스트 격리: {{ isolation_result.status }}
            - 방화벽 차단: {{ firewall_result.status }}
            - 포렌식 수집: 완료

            ### 다음 단계
            - [ ] 악성코드 분석
            - [ ] 영향 범위 파악
            - [ ] 근본 원인 분석
            - [ ] 복구 계획 수립

outputs:
  - isolation_status: "{{ isolation_result.status }}"
  - case_id: "{{ ticket_id }}"
  - forensic_collected: true

rollback:
  - step: 1
    name: "격리 해제"
    condition: manual_trigger
    actions:
      - action: unisolate_host
        target: EDR
        params:
          hostname: "{{ host_name }}"

      - action: unblock_ip
        target: Firewall
        params:
          ip: "{{ host_ip }}"
